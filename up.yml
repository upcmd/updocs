version: 1.0.0

vars:
  cached_functests_dir: ./build/functests
  cases_dir: ./build/cases
  log_dir: ./reflogs
  content_dir: ./content

dvars:
  - name: upproj_dir
    value: '{{ env "UP_PROJ_DIR" |validateMandatoryFailIfNone "upproj_dir" }}'
    flags: [vvv]

  - name: src_functests_dir
    value: '{{.upproj_dir}}/tests/functests'

  - name: ref_dir
    value: '{{.cached_functests_dir}}'

tasks:
  -
    name: build
    desc: build the showcases automatically
    task:

      -
        func: shell
        desc: prepare all the self documented cases
        do:
          - rm -rf ./build
          - mkdir -p ./build
          - 'cp -rf {{.src_functests_dir}} {{.cached_functests_dir}}'
          - 'cd {{.cached_functests_dir}}; ls c????.yml'
        reg: cases

      - func: cmd
        desc: debug
        do:
          -
            name: print
            cmd: '{{.cases}}'

      - func: cmd
        desc: get the case list object
        dvars:
          - name: void
            value: '{{ .cases | splitLines |reg "caselist" }}'

      - func: cmd
        desc: show the caselist available
        do:
          -
            name: print
            cmd: 'cases: {{.caselist}}'

      -
        func: shell
        desc: prepare the directory for the already documented cases
        do:
          - rm -rf {{.cases_dir}}
          - mkdir -p {{.cases_dir}}

      -
        func: call
        desc: filter out all cases have already got documents
        do:
          - process_case
        loop: "caselist"

      -
        func: shell
        desc: copy generated docs to publish dir
        do:
          - rm -rf {{.content_dir}}/cases
          - 'cp -rf {{.cases_dir}} {{.content_dir}}/'

  -
    name: process_case
    task:

      -
        func: cmd
        do:
          - name: reg
            cmd:
              name: casename
              value: '{{.loopitem}}'

          - name: print
            cmd: 'processing {{.casename}}'

          - name: readfile
            desc: read yml file
            cmd:
              filename: '{{.casename}}'
              dir: '{{.cached_functests_dir}}'
              reg: caseyml

          - name: print
            cmd: |
              yml file content:
              {{.caseyml}}

          - name: query
            cmd:
              ymlkey: caseyml
              path: doc_meta.
              ymlonly: true
              reg: docyml

          - name: yml_delete
            cmd:
              ymlfile: '{{.casename}}'
              refdir: '{{.ref_dir}}'
              path: doc_meta
              inplace: true

          - name: readfile
            desc: review if the file content is correct
            cmd:
              filename: '{{.casename}}'
              dir: '{{.ref_dir}}'
              reg: final_yml

          - name: print
            desc: show the modified yml content
            cmd: '{{.final_yml}}'

      -
        func: cmd
        dvars:
          - name: casedoc
            value: '{{.docyml}}'
            expand: 2
            flags: [to_object, reg]

      -
        func: call
        desc: create sub folders and template the docment
        do: generate_doc
        if: '{{ gt (.casedoc|len) 0 }}'

  -
    name: generate_doc
    task:
      - func: cmd
        do:
          - name: reg
            cmd:
              name: target_dir
              value: '{{.cases_dir}}/{{.casedoc_object.folder}}'

      - func: shell
        do:
          - 'mkdir -p {{.target_dir}}'

      -
        func: cmd
        do:
          - name: printobj
            cmd: casedoc_object

          - name: print
            desc: casedoc length
            cmd: '{{ .casedoc|len }}'

          - name: template
            desc: generate the document
            cmd:
              src: ./templates/doc.template
              dest: '{{.target_dir}}/{{.casename | replace ".yml" ""}}.md'
              datakey: casedoc_object
